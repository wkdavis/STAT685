---
title: "Seoul Bike Data"
author: 
  - William K Davis III
  - Pei-Yin Yang
  - Max Kutschinski
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  cache = TRUE
  )
library(readr)
library(dplyr)
library(tsibble)
library(fabletools)
library(feasts)
library(ggplot2)
library(lubridate)
library(caret)
library(gridExtra)
library(corrplot)
```

http://archive.ics.uci.edu/ml/bikesets/Seoul+Bike+Sharing+Demand

```{r read}
bike <- readr::read_csv("SeoulBikeData.csv",
                        col_names = c("Date",
                                      "BikeCount",
                                      "Hour",
                                      "Temperature",
                                      "Humidity",
                                      "WindSpeed",
                                      "Visibility",
                                      "Dewpoint",
                                      "SolarRadiation",
                                      "Rainfall",
                                      "Snowfall",
                                      "Seasons",
                                      "Holiday",
                                      "FunctionalDay"),
                        skip = 1,
                        col_types = cols("Hour" = col_time(format = "%H"),
                                         Seasons = "f", 
                                         Holiday = "f",
                                         FunctionalDay = "f"))
```


```{r clean-ts}
bikets <- bike %>%
  mutate(
    Hour = parse_date_time(
      paste(Date, Hour),
      orders = c("dmy HMS", "dmY HMS"),
      tz = "Asia/Seoul"
    ),
    .before = everything(),
    Date = NULL
  ) %>%
  as_tsibble(index = Hour)
  
bikets %>% count_gaps()
```

## Data Summary

```{r echo =T}
colnames(bikets)
anyNA(bikets)
dim(bikets)
str(bikets)
summary(bikets) # Investigate BikeCount = 0 and Humidity = 0
```

- Notice there are no missing values. However there are some observations with BikeCount = 0, which correspond to non-functional days. Can these be treated as missing values and be imputed? Non-functional days are only present in 2018. 
- Humidity has a minimum value of 0. Is this realistic? (see feature plot for further investigation)




## Feature Plots

```{r echo=F}
theme_set(theme_bw())

# modeling continuous features

X = select_if(bike, is.numeric)
Y = select(bike, BikeCount) %>% unlist()
featurePlot(X,Y)
```

Something seems to be going on with humidity = 0 values.

\newpage

## Correlation Plot

```{r echo=F}
corrplot(cor(X), order = "hclust", tl.cex = .35)
```

Dewpoint and Temperature potentially problematic

\newpage

## Bike Demand by Hour of Day

```{r echo=F, message=F,warning=F}
bike$Hour = hour(bike$Hour)

p1 = bike%>%group_by(Hour)%>%summarise(BikeCountMean = mean(BikeCount))%>%data.frame()%>%
  ggplot(mapping = aes(x=Hour ,y = BikeCountMean)) +
  geom_line()+
  geom_hline(aes(yintercept = mean(bike$BikeCount)), color = "red") +
  labs(y = "Average Bike Count",
       title = "Average Bike Demand by Hour of Day")


p2 = bike%>%group_by(Seasons,Hour)%>%summarise(BikeCountMean = mean(BikeCount))%>%data.frame()%>%
  ggplot(mapping = aes(x=Hour,y = BikeCountMean,color = Seasons, fill= Seasons)) +
  geom_line()+
  labs(y = "Average Bike Count",
       title = "Seasonal Average Bike Count by Hour of Day")

grid.arrange(p1,p2,ncol=1)

```


## Time Series Plots

* pair-plots
* TS plots
* ACF plot, KPSS test
* STL decomp

```{r EDA}
autoplot(bikets, .vars = BikeCount) + labs(title = "Bike Count by Hour")
sapply(bikets, function(x) sum(is.na(x)))
hist(bikets$BikeCount)
# plot(select(select(bikets, -Hour), where(is.numeric)))
```


```{r ts-EDA}
ACF(bikets, BikeCount) %>% autoplot()
features(bikets, BikeCount, 
         c(unitroot_kpss, ljung_box, unitroot_ndiffs, unitroot_nsdiffs))
```

Very strong autocorrelation as expected, with a peak during the same hour of
the previous day.

```{r model}
library(fable.prophet)
fit <- bikets %>%
  model(
    mdl = prophet(BikeCount ~ growth("linear") + season("day", type = "multiplicative") + season("week", type = "multiplicative")),
  )
components(fit) %>% autoplot()

```




Modeling ideas:

* Prophet
* LSTM

---
title: "Seoul Bike Data"
author: 
  - William K Davis III
  - Pei-Yin Yang
  - Max Kutschinski
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  cache = TRUE
  )
library(readr)
library(dplyr)
library(tsibble)
library(fabletools)
library(feasts)
library(ggplot2)
library(lubridate)
library(caret)
library(gridExtra)
library(corrplot)
library(tidyr)
library(GGally)
```

http://archive.ics.uci.edu/ml/bikesets/Seoul+Bike+Sharing+Demand

# Read Data

```{r read}
bike <- readr::read_csv("SeoulBikeData.csv",
                        col_names = c("Date",
                                      "BikeCount",
                                      "Hour",
                                      "Temperature",
                                      "Humidity",
                                      "WindSpeed",
                                      "Visibility",
                                      "Dewpoint",
                                      "SolarRadiation",
                                      "Rainfall",
                                      "Snowfall",
                                      "Seasons",
                                      "Holiday",
                                      "FunctionalDay"),
                        skip = 1,
                        col_types = cols("Hour" = col_time(format = "%H"),
                                         Seasons = "f", 
                                         Holiday = "f",
                                         FunctionalDay = "f"))
```

## Data Cleaning

```{r clean-ts}
bikets <- bike %>%
  mutate(
    Hour = parse_date_time(
      paste(Date, Hour),
      orders = c("dmy HMS", "dmY HMS"),
      tz = "Asia/Seoul"
    ),
    .before = everything(),
    Date = NULL
  ) %>%
  as_tsibble(index = Hour)

bikets_tall <- bikets %>%
  select(Hour, where(is.numeric)) %>%
  pivot_longer(cols = -Hour,
               names_to = "Measure",
               values_to = "Value")
  
bikets %>% count_gaps()
```

# EDA

## Data Summary

```{r echo =T}
colnames(bikets)
anyNA(bikets)
dim(bikets)
str(bikets)
summary(bikets) # Investigate BikeCount = 0 and Humidity = 0
```

- Notice there are no missing values. However there are some observations with BikeCount = 0, which correspond to non-functional days. Can these be treated as missing values and be imputed? Non-functional days are only present in 2018. 
- Humidity has a minimum value of 0. Is this realistic? (see feature plot for further investigation)


## Feature Plots

```{r echo=F}
theme_set(theme_bw())

# modeling continuous features

X = select_if(bike, is.numeric)
Y = select(bike, BikeCount) %>% unlist()
featurePlot(X,Y)
```

Something seems to be going on with humidity = 0 values.

\newpage

## Correlation Plot

```{r echo=F}
ggscatmat(bike, 
          columns = c("BikeCount", "Temperature", "Humidity", "WindSpeed", 
                      "Visibility", "Dewpoint", "SolarRadiation", "Rainfall", 
                      "Snowfall"), 
          alpha = .2)
corrplot(cor(X), order = "hclust", tl.cex = .35)
```

Dewpoint and Temperature potentially problematic

\newpage

## Bike Demand by Hour of Day

```{r echo=F, message=F,warning=F}
bike$Hour = hour(bike$Hour)

p1 = bike%>%group_by(Hour)%>%summarise(BikeCountMean = mean(BikeCount))%>%data.frame()%>%
  ggplot(mapping = aes(x=Hour ,y = BikeCountMean)) +
  geom_line()+
  geom_hline(aes(yintercept = mean(bike$BikeCount)), color = "red") +
  labs(y = "Average Bike Count",
       title = "Average Bike Demand by Hour of Day")


p2 = bike%>%group_by(Seasons,Hour)%>%summarise(BikeCountMean = mean(BikeCount))%>%data.frame()%>%
  ggplot(mapping = aes(x=Hour,y = BikeCountMean,color = Seasons, fill= Seasons)) +
  geom_line()+
  labs(y = "Average Bike Count",
       title = "Seasonal Average Bike Count by Hour of Day")

grid.arrange(p1,p2,ncol=1)

```


## Time Series Plots

```{r EDA}
autoplot(bikets, .vars = BikeCount) + labs(title = "Bike Count by Hour")
hist(bikets$BikeCount)
bikets_tall %>%
  ggplot(aes(x = Hour, y = Value, color = Measure)) +
  geom_line() +
  facet_grid(rows = vars(Measure), scales = "free_y")
ACF(bikets_tall, Value) %>% autoplot()
features(bikets_tall, Value, 
         c(unitroot_kpss, unitroot_ndiffs, unitroot_nsdiffs, ljung_box))
```

KPSS and Ljung-Box Test both indicate (auto)correlation within each
variable.

# Modeling

## Time Series

* Prophet
* fasster


```{r model-prophet, eval=FALSE}
library(fable.prophet)

holidays <- bikets %>% 
  filter(Holiday == "Holiday") %>%
  mutate(ds = as.Date(Hour)) %>%
  distinct(ds) %>% 
  mutate(holiday = "holiday")

fit <- bikets %>%
  model(
    mdl = prophet(BikeCount ~ season(period = "day", type = "multiplicative") + season(period = "week", type = "multiplicative") + holiday(holidays = holidays)),
  )
components(fit) %>% autoplot()

```

## Machine Learning

* LSTM
* RNN


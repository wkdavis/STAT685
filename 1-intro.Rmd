---
title: "Introduction"
author: "William K Davis III"
date: "`r Sys.Date()`"
output:
  pdf_document:
    citation_package: natbib
bibliography: citations.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
  )
library(magrittr)
library(dplyr)
library(tsibble)
library(readr)
library(lubridate)
library(ggplot2)
library(fabletools)
library(feasts)
library(gridExtra)
library(GGally)
options(scipen = 999)
```

## Introduction

While the concept of renting transportation has been around for decades in
the form of rental car companies, such as those often found at airports, it
has also been adapted to the modern "sharing economy" in the form of
bikeshare programs. These programs, often offered by local governments, allow
users to rent bicycles for individual (point-to-point) trips, such as commuting
to and from work. Cycling can be a faster mode of transportation than walking
and might even be faster than driving or taking a taxi in the most congested
of cities. Finally, bicycles offer a lower-pollution alternative to driving,
which can be appealing to cities struggling to contain emissions.

A key challenge faced by administrators of bikesharing programs is the efficient
allocation of available bicycles. Bikes must be available in the places that
people need them and at the time they are needed in order for the program to
be effective. In order to efficiently allocate bikes, administrators can
periodically transport bikes from areas of low demand to areas of high demand
(@schuijbroek). Demand in a bikeshare system is a function of both time
and location. In this paper we focus on the time component of
the demand for bicycles at each hour of the day, ignoring the spatial
component of demand. We will use the Seoul Bike Sharing Demand data from
UCI (@bikedata). Our focus will be limited to predicting demand at each hour
of the day, ignoring inferential aspects of the analysis. While much of the
recent research using this dataset has focused on machine learning
methodologies, we will take a multifaceted approach that incorporates
advances in time series modeling in addition to the popular machine learning
methodologies.

This paper begins with a review of the [relevant literature](#literature),
including studies of the Seoul data specifically. Next, we present the results
of the exploratory data analysis, including a description of the dataset and
relevant profiles of the features. In part 

## Literature

The popularity and accessibility of the Seoul bike dataset has resulted in its
use for numerous studies. A majority of these studies have focused on the
use of various machine learning algorithms. Sathishkumar and Yongyun found that
a CUBIST model, which combines tree- and regression-based methods into a series
of rules, performed best on the Seoul data when measured by $R^2$ and RMSE on
the testing dataset (@sathishkumar). Gao and Chen found that another tree-based
method, random forest (RF), performed best on a similar bikeshare dataset when
measured by $R^2$ and RMSE (@gao). Both studies further showed
that weather-related variables, such as temperatures and precipitation, where
among the most important for predicting demand. Gao and Chen's results
highlight the importance of selecting a relevant evaluation metric and explanatory
variables. When socioeconomic variables were included in the model, the
RF outperformed the support vector machine (SVM) when measured by both
RMSE and MAE. However, when the socioeconomic variables were excluded from the
model, the RF outperformed the SVM when measured by RMSE, but the SVM
performed better when measured by MAE This indicates that without the
socioeconomic variables included, the SVM was prone to a few errors that were
quite large in magnitude, while the RF was more prone to smaller but more
frequent errors. This reinforces the importance of using multiple metrics when
evaluating predictions.

Considerably fewer researchers have made use of traditional time series
methodologies when predicting demand of a similar nature to the bikeshare data.
Both (@sathishkumar) and (@gao) make use of temporal variables such as hour,
day of the week, and holidays. In each case they were found to be of moderate or
high importance. (@gao) applied linear regression using temporal
variables such as a weekend indicator as a predictor, but this model greatly
underperformed the machine learning methods. Further, there is no discussion of
any attention paid to stationarity and autoregression, which are common in time
series data but may also result in violations of the standard assumptions of
linear regression.

Our analysis looks to build on this work by using newer machine learning
methods such as long short-term memory and recurrent neural networks, as well
as modern time series techniques that leverage the underlying structure of the
data.

## Exploratory Analysis

```{r read-data}
bikets <- readr::read_csv("SeoulBikeData.csv",
                        col_names = c("Date",
                                      "BikeCount",
                                      "Hour",
                                      "Temperature",
                                      "Humidity",
                                      "WindSpeed",
                                      "Visibility",
                                      "Dewpoint",
                                      "SolarRadiation",
                                      "Rainfall",
                                      "Snowfall",
                                      "Seasons",
                                      "Holiday",
                                      "FunctionalDay"),
                        skip = 1,
                        col_types = cols("Hour" = col_time(format = "%H"),
                                         Seasons = "f",
                                         Holiday = "f",
                                         FunctionalDay = "f")) %>%
  mutate(
    Hour = parse_date_time(
      paste(Date, Hour),
      orders = c("dmy HMS", "dmY HMS"),
      tz = "Asia/Seoul"
    ),
    .before = everything(),
    Date = NULL,
    BikeCount = ifelse(FunctionalDay == "Yes", BikeCount, NA),
    FunctionalDay = NULL,
    Holiday = forcats::fct_relevel(Holiday, "No Holiday"),
    Workday = factor(ifelse(((lubridate::wday(Hour, label = TRUE) %in% c("Sat", "Sun")) | Holiday == "Holiday"), "Not Workday", "Workday"), levels = c("Workday", "Not Workday"))
  ) %>%
  as_tsibble(index = Hour)

# bikets_tall <- bikets %>%
#   select(where(is.numeric)) %>%
#   tidyr::pivot_longer(cols = -Hour, names_to = "Measure", values_to = "Value")
# 
# bikets_tall %>%
#   ggplot(aes(x = Hour, y = Value, color = Measure)) +
#   geom_line() +
#   facet_grid(rows = vars(Measure), scales = "free_y")

```

The dataset consists of `r scales::comma(nrow(bikets))` hourly observations of
`r ncol(bikets)-1` variables from
`r paste(range(bikets$Hour), collapse = " to ")`. There are
`r sum(is.na(bikets$BikeCount))` observations where *BikeCount*=0 due to the
bikeshare system not functioning. There are no other periods where
*BikeCount*=0. \@ref(tab:dictionary) contains information on the variables in
the dataset, including the 

```{r dictionary}
tibble::tribble(
  ~Variable, ~name, ~Type, ~Definition,
  "Hour", "Hour", "datetime", "year-month-day hour:minute:second",
  "Rented Bike count", "BikeCount", "numeric", "Count of bikes rented at each hour",
  "Temperature", "Temperature", "numeric", "Temperature in Celsius",
  "Humidity", "Humidity", "numeric", "% humidity",
  "Windspeed", "WindSpeed", "numeric", "meters/second",
  "Visibility", "Visibility", "numeric", "in 10m",
  "Dew point temperature", "Dewpoint", "numeric", "Celsius",
  "Solar radiation", "SolarRadtion", "numeric", "MJ/m2",
  "Rainfall", "Rainfall", "numeric","mm",
  "Snowfall", "Snowfall", "numeric","cm",
  "Seasons", "Seasons", "categorical", "Winter, Spring, Summer, Autumn",
  "Holiday", "Holiday", "categorical", "Holiday/No holiday",
  "Functional Day", "FunctionalDay", "categorical", "NoFunc(Non Functional Hours), Fun(Functional hours)",
  "Workday", "Workday", "categorical", "Workday/Not Workday. A workday is a weekday that is not a holiday."
) %>%
  knitr::kable(caption = "Variable definitions")
```

### Bike Count

```{r timeplot, fig.width=8, fig.cap="Hourly bike demand"}
# autoplot(bikets, BikeCount) +
#   labs(title = "Hourly Bike Demand", x = NULL)
# ggplot(bikets, aes(x = BikeCount)) +
#   geom_histogram(fill = "grey", color = "black") +
#   theme_bw() +
#   labs(title = "Distribution of Bike Count", x = "Bike Count", y = "# of Days")
gg_tsdisplay(bikets, BikeCount, plot_type = "histogram", lag_max = 24*7) +
  labs(title = "Hourly Bike Demand")
```

The data shows increasing demand and variability during the summer months. The
bike demand data are counts, meaning they are technically discrete. Based on
the histogram and the count nature of the data, it appears that a poisson
distribution would be most appropriate for the data. If we were to model the
bike demand on a continuous scale, a log-normal distribution might be
appropriate.

\@ref(fig:timeplot) highlights the incredible variation in demand over time.
The variance in demand appears to increase during the summer months and then
decrease again in the autumn. This heteroskedasticity violates the constant
variance assumption of ordinary least squares regression and will have to be
corrected if regression-based methods are to be used. We can also see that the
mean of the series appears to increase during the summer months before decreasing
again in the autumn.

```{r ts-tests}
tstests <- features(bikets, BikeCount, c(unitroot_kpss,
                                         ~ljung_box(., lag = 24)))

# gg_lag(bikets, BikeCount, period = "hour", lags = 1:24, geom = "point", col = "black", size = .25) +
#   scale_x_continuous(labels = scales::comma_format(scale = .001, suffix = "k", accuracy = 1)) +
#   scale_y_continuous(labels = scales::comma_format(scale = .001, suffix = "k", accuracy = 1))
# gg_season(bikets, y = BikeCount, period = "day", color = "black")
# gg_subseries(bikets, y = BikeCount, period = "day")
```

A KPSS test yields $p=$ `r tstests$kpss_pvalue`, meaning there is strong
evidence in favor of the presence of a unit root and the data is likely
non-stationary (@kpss). A Ljung-Box test was conducted up to 24 lags which
resulted in a test statistics of `r round(tstests$lb_stat)` with
$p=$ `r tstests$lb_pvalue`, indicating strong evidence that there is serial
correlation in the hourly bike count (@ljung). The acf plot in Figure A shows
that autocorrelation is significant at most lags out to 168 hours, which
represents the same hour of the same day in the previous week. The strong
serial correlation makes this dataset a good candidate for time series
techniques.

```{r season-plots, fig.width = 8, fig.cap="Hourly bike demand by time period"}
grid.arrange(
ggplot(bikets, aes(x = format(Hour, "%H"), y = BikeCount, fill = lubridate::hour(Hour))) +
  geom_boxplot() +
  scale_fill_viridis_b() +
  labs(x = "Hour of Day", title = "Hourly Bike Count by Hour", y = "Hourly Bike Demand") +
  theme(legend.position = "none"),
ggplot(bikets, aes(x = lubridate::wday(Hour, label = TRUE), y = BikeCount, fill = lubridate::wday(Hour, label = TRUE))) +
  geom_boxplot() +
  labs(x = "Day of Week", title = "Hourly Bike Count by Day of Week", y = "Hourly Bike Demand") +
  theme(legend.position = "none"),
ggplot(bikets, aes(x = Workday, y = BikeCount, fill = Workday)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  labs(x = "Workday Indicator", title = "Hourly Bike Count by Working Day", y = "Hourly Bike Demand") +
  theme(legend.position = "none"),
ggplot(bikets, aes(x = Seasons, y = BikeCount, fill = Seasons)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  labs(x = "Season", title = "Hourly Bike Count by Season", y = "Hourly Bike Demand") +
  theme(legend.position = "none"),
newpage = FALSE
)
```

Figure 2 highlights various seasonal and temporal patterns in the data. There
is certainly an effect based on the hour of day, with demand increasing
sharply in the morning, presumably during the morning commute, before decreasing
into the lunchtime hour. From there, demand rises steadily through the evening
commute before peaking around dinner time and then falling through the
nighttime hours. Variability also appears greater during the evening hours,
which is consistent with the idea heteroscedasticity; the variance increases
with the level of the series. Demand appears slightly higher during 
workdays (where workdays are weekdays that are not holidays) and weekdays,
though the difference does not appear particularly large. There are a number
of large positive outliers during the weekdays. Finally, demand appears
largest during the summer months and smallest during the winter, as biking would
be a less desirable option in the cold.

Figure 3 provides insight into the seasonality of the bike demand. Each panel
is a 4-week sample of hourly bike demand, with non-workdays (weekends and
holidays) highlighted in red. While these days appear to follow a consistent
hourly pattern much like the workdays, we can see that their is a difference
between the seasonality of workdays and the seasonality of non-workdays. Most
notably, the troughs in demand appear consistent between the types of days
while the peaks are consistently higher for workdays as compared to
non-workdays. This changing seasonality based on type of day will need to be
captured in our model.

```{r seasonality-weekends, fig.cap="Hourly demand by day type"}
grid.arrange(
bikets[1000:1672,] %>%
  select(Hour, BikeCount, Workday) %>%
  mutate(`Not Workday` = ifelse(Workday == "Not Workday", BikeCount, NA),
         `Workday` = ifelse(Workday == "Workday", BikeCount, NA)) %>%
  tidyr::gather("Day Type", "BikeCount", `Workday`, `Not Workday`) %>%
ggplot(aes(x = Hour, y = BikeCount, color = `Day Type`)) +
  geom_line() +
  theme(legend.position = "top") +
  labs(title = "Hourly Demand by Day Type"),
bikets[3000:3672,] %>%
  select(Hour, BikeCount, Workday) %>%
  mutate(`Not Workday` = ifelse(Workday == "Not Workday", BikeCount, NA),
         `Workday` = ifelse(Workday == "Workday", BikeCount, NA)) %>%
  tidyr::gather("Day Type", "BikeCount", `Workday`, `Not Workday`) %>%
ggplot(aes(x = Hour, y = BikeCount, color = `Day Type`)) +
  geom_line()+
  theme(legend.position = "none"),
bikets[5000:5672,] %>%
  select(Hour, BikeCount, Workday) %>%
  mutate(`Not Workday` = ifelse(Workday == "Not Workday", BikeCount, NA),
         `Workday` = ifelse(Workday == "Workday", BikeCount, NA)) %>%
  tidyr::gather("Day Type", "BikeCount", `Workday`, `Not Workday`) %>%
ggplot(aes(x = Hour, y = BikeCount, color = `Day Type`)) +
  geom_line()+
  theme(legend.position = "none"),
bikets[6000:6672,] %>%
  select(Hour, BikeCount, Workday) %>%
  mutate(`Not Workday` = ifelse(Workday == "Not Workday", BikeCount, NA),
         `Workday` = ifelse(Workday == "Workday", BikeCount, NA)) %>%
  tidyr::gather("Day Type", "BikeCount", `Workday`, `Not Workday`) %>%
ggplot(aes(x = Hour, y = BikeCount, color = `Day Type`)) +
  geom_line()+
  theme(legend.position = "none"),
newpage = FALSE)
```

Continuing with the impact of seasonality and temperature on demand, we will next
explore the covariates included with the dataset.

### Covariates

This dataset includes a number of covariates to aid in modeling bike demand.
All of these covariates are listed in Table 1, along with their definitions.
The covariates fall into one of two broad categories: weather and
social. Weather covariates include variables such as temperature, humidity,
precipitation, and others. Social variables capture the impact of calendar-based
human behavior, such as holidays and weekends.

```{r covariates, fig.width=8}
# select(bikets, where(is.numeric)) %>%
#   select(-Hour) %>%
#   ggpairs()
```
